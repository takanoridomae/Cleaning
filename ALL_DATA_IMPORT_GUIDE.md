# 全データベースインポート手順書

## 📋 概要

ローカルのaircon_report.dbの全テーブルデータをデプロイ環境（Render）に一括インポートする手順です。

## 🎯 対象テーブル

以下の9つのテーブルのデータを一括でインポートします：

1. **users** (3件) - ユーザー情報
2. **customers** (3件) - 顧客情報
3. **properties** (51件) - 物件情報
4. **reports** (52件) - 報告書情報
5. **photos** (150件) - 写真情報
6. **air_conditioners** (114件) - エアコン情報
7. **work_times** (55件) - 作業時間情報
8. **work_details** (94件) - 作業詳細情報
9. **work_items** (20件) - 作業項目情報

**総計: 542件のレコード**

## 🚀 実行手順

### ステップ1: 全データエクスポート（ローカル）

```bash
# プロジェクトルートで実行
python scripts/export_all_data.py
```

**出力例:**
```
🚀 全テーブルデータエクスポート開始...
📋 usersテーブルをエクスポート中...
  ✅ 3件のデータを取得
📋 customersテーブルをエクスポート中...
  ✅ 3件のデータを取得
...
🎉 エクスポート完了!
📁 ファイル名: all_data_export_20250628_223248.json
📊 総レコード数: 542件
💾 ファイルサイズ: 0.23MB
```

### ステップ2: デプロイ環境でのインポート

1. **デプロイ環境にアクセス**
   - Render管理画面にログイン
   - 管理者ユーザーでアプリケーションにログイン

2. **全データアップロード画面にアクセス**
   ```
   システム管理 → 全データアップロード
   ```
   または直接URL:
   ```
   https://your-app.onrender.com/admin/upload-all-data
   ```

3. **ファイルアップロード**
   - 「全データJSONファイルを選択」ボタンをクリック
   - `all_data_export_YYYYMMDD_HHMMSS.json` を選択
   - 「全データアップロード開始」ボタンをクリック

### ステップ3: 結果確認

成功すると以下のメッセージが表示されます：

```
🎉 全データインポート完了!
📊 総計: 新規XXX件, 更新XXX件
• users: 新規X件, 更新X件
• customers: 新規X件, 更新X件
• properties: 新規X件, 更新X件
...
```

## ⚙️ 技術的な詳細

### データ変換処理

- **日付フィールド**: 文字列 → datetime オブジェクト
- **時刻フィールド**: 文字列 → time オブジェクト
- **ID保持**: 元のIDを維持してインポート

### インポート順序

依存関係を考慮した順序でインポート：
1. users (基本ユーザー)
2. customers (顧客)
3. properties (物件)
4. reports (報告書)
5. photos (写真)
6. air_conditioners (エアコン)
7. work_times (作業時間)
8. work_details (作業詳細)
9. work_items (作業項目)

### エラー処理

- **重複レコード**: IDが一致する場合は更新
- **新規レコード**: 新しいIDの場合は追加
- **日付変換エラー**: 現在時刻で代替
- **フィールドエラー**: スキップして継続

## 🔧 トラブルシューティング

### よくある問題

1. **ファイルサイズエラー**
   - 解決策: ファイルサイズを確認（通常0.2-0.3MB）

2. **日付変換エラー**
   - 解決策: 自動的に現在時刻で代替処理

3. **外部キー制約エラー**
   - 解決策: インポート順序を依存関係順に設定済み

4. **認証エラー**
   - 解決策: 管理者ユーザーでログインしているか確認

### ログ確認

デプロイ環境のログで詳細を確認：
```
📋 usersテーブルをインポート中...
  ✅ users: 新規3件, 更新0件, エラー0件
📋 customersテーブルをインポート中...
  ✅ customers: 新規3件, 更新0件, エラー0件
...
```

## 📊 データ確認

インポート後、各テーブルのデータ数を確認：

```bash
python check_aircon_count.py
```

または画面上部の「現在のデータ状況」で確認。

## ⚠️ 注意事項

1. **バックアップ**: インポート前に既存データのバックアップを推奨
2. **データ量**: 大量データの場合は処理時間がかかる場合があります
3. **重複処理**: 同じIDのレコードは上書きされます
4. **権限**: 管理者権限が必要です

## 🔄 定期実行

定期的にローカルデータをデプロイ環境に同期する場合：

1. ローカルでエクスポート実行
2. 最新のJSONファイルをデプロイ環境にアップロード
3. 結果確認

これにより、開発環境とデプロイ環境のデータを同期できます。 