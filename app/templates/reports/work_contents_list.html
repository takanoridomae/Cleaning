{% extends 'base.html' %}

{% block title %}作業内容一覧表{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2>作業内容一覧表</h2>
            <p>実施された作業内容の詳細一覧です。</p>
        </div>
    </div>
    
    <!-- 検索・フィルター -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>検索・フィルター</h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('reports.work_contents_list') }}">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="search" class="form-label">キーワード検索</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ search_keyword }}" placeholder="物件名、顧客名、作業内容など">
                    </div>
                    <div class="col-md-3">
                        <label for="work_item" class="form-label">作業項目</label>
                        <select class="form-select" id="work_item" name="work_item">
                            <option value="">全ての作業項目</option>
                            {% for item in work_items_list %}
                            <option value="{{ item }}" {{ 'selected' if work_item_filter == item else '' }}>
                                {{ item }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="start_date" class="form-label">作業開始日</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" 
                               value="{{ start_date }}">
                    </div>
                    <div class="col-md-2">
                        <label for="end_date" class="form-label">作業終了日</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" 
                               value="{{ end_date }}">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <div class="btn-group w-100">
                            <button type="submit" class="btn btn-primary">検索</button>
                            <a href="{{ url_for('reports.work_contents_list') }}" class="btn btn-outline-secondary">クリア</a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 結果表示 -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>作業内容一覧 ({{ work_contents.total }}件)</h5>
            <div class="btn-group">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                            data-bs-toggle="dropdown" aria-expanded="false">
                        ソート
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('reports.work_contents_list', search=search_keyword, work_item=work_item_filter, start_date=start_date, end_date=end_date, sort='work_date', order='desc') }}">作業日 (新しい順)</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('reports.work_contents_list', search=search_keyword, work_item=work_item_filter, start_date=start_date, end_date=end_date, sort='work_date', order='asc') }}">作業日 (古い順)</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('reports.work_contents_list', search=search_keyword, work_item=work_item_filter, start_date=start_date, end_date=end_date, sort='property_name', order='asc') }}">物件名 (A-Z)</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('reports.work_contents_list', search=search_keyword, work_item=work_item_filter, start_date=start_date, end_date=end_date, sort='customer_name', order='asc') }}">顧客名 (A-Z)</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('reports.work_contents_list', search=search_keyword, work_item=work_item_filter, start_date=start_date, end_date=end_date, sort='work_item', order='asc') }}">作業項目名 (A-Z)</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            {% if work_contents.items %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>作業日</th>
                                <th>開始時間</th>
                                <th>終了時間</th>
                                <th>顧客名</th>
                                <th>物件名</th>
                                <th>エアコン情報</th>
                                <th>作業項目</th>
                                <th>作業内容</th>
                                <th>作業確認</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in work_contents.items %}
                            <tr>
                                <td>{{ item.work_date.strftime('%Y-%m-%d') if item.work_date else '-' }}</td>
                                <td>{{ item.start_time.strftime('%H:%M') if item.start_time else '-' }}</td>
                                <td>{{ item.end_time.strftime('%H:%M') if item.end_time else '-' }}</td>
                                <td>{{ item.customer_name or '-' }}</td>
                                <td>{{ item.property_name or '-' }}</td>
                                <td>
                                    {% if item.manufacturer or item.model_number or item.location %}
                                        <small>
                                            {% if item.manufacturer %}{{ item.manufacturer }}{% endif %}
                                            {% if item.model_number %}<br>{{ item.model_number }}{% endif %}
                                            {% if item.location %}<br>({{ item.location }}){% endif %}
                                        </small>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ item.work_item_name or '-' }}</span>
                                </td>
                                <td>
                                    <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                                        {{ item.description or '-' }}
                                    </div>
                                </td>
                                <td>
                                    <div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">
                                        {{ item.confirmation or '-' }}
                                    </div>
                                </td>
                                <td>
                                    <a href="{{ url_for('reports.view', id=item.report_id) }}" 
                                       class="btn btn-sm btn-outline-primary" 
                                       title="報告書を見る">
                                        <i class="fas fa-eye"></i> 報告書
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- ページネーション -->
                {% if work_contents.pages > 1 %}
                <nav aria-label="作業内容ページネーション" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if work_contents.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('reports.work_contents_list', page=work_contents.prev_num, search=search_keyword, work_item=work_item_filter, start_date=start_date, end_date=end_date, sort=sort_by, order=sort_order) }}">前へ</a>
                            </li>
                        {% endif %}
                        
                        {% for page_num in work_contents.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != work_contents.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('reports.work_contents_list', page=page_num, search=search_keyword, work_item=work_item_filter, start_date=start_date, end_date=end_date, sort=sort_by, order=sort_order) }}">{{ page_num }}</a>
                                    </li>
                                {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">…</span>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if work_contents.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('reports.work_contents_list', page=work_contents.next_num, search=search_keyword, work_item=work_item_filter, start_date=start_date, end_date=end_date, sort=sort_by, order=sort_order) }}">次へ</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            {% else %}
                <div class="text-center py-5">
                    <p class="text-muted">検索条件に一致する作業内容が見つかりませんでした。</p>
                    <a href="{{ url_for('reports.work_contents_list') }}" class="btn btn-outline-primary">
                        全ての作業内容を表示
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 検索フォームの自動送信（エンターキー）
    document.getElementById('search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            this.form.submit();
        }
    });
    
    // 作業項目選択時の自動送信
    document.getElementById('work_item').addEventListener('change', function() {
        this.form.submit();
    });
    
    // 日付選択時の自動送信
    document.getElementById('start_date').addEventListener('change', function() {
        this.form.submit();
    });
    
    document.getElementById('end_date').addEventListener('change', function() {
        this.form.submit();
    });
</script>
{% endblock %} 